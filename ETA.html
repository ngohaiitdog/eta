<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="shortcut icon" sizes="192x192" href="bus-clock.png">
    <title>ETA</title>
</head>
<style>
    * {
        box-sizing: border-box;
    }
    .heading {
        text-decoration: underline;
	    font-size: 1.3em;
        margin-bottom: 0;
        margin-top: 0;
    }

    div {
        font-size: 1.3em;
        font-family: 'Arial' , '微軟正黑體';
        padding-bottom: 0;
        padding-top: 0;
		margin-bottom: 0;
		margin-top: 0;
    }
	
	.centreblock {
        width: 65%;
        overflow: auto;
        float: left;
	}

	.leftblock {
		left: 5px;
        overflow: auto;
        width: 35%;
        float: left;
	}

	.header {
		left: 5px;
		border-style: solid;
        overflow: auto;
        width: 100%;
        float: left;
	}

    .dest {
	    font-size: 0.9em;
    }


    span {
        font-size: 1.3em;
        font-family: 'Arial' , '微軟正黑體';
        padding-bottom: 0;
        padding-top: 0;
		margin-bottom: 0;
		margin-top: 0;
    }
	button {
		top: 5px;
	}
	
    body {
        word-break: keep-all;
        width: 360px;
        overflow: auto;
        font-size: 100%;
    }

    .remark {
        position: relative;
        display: inline-block;
        font-size: 0.9em;
    }

    .tooltiptext {
        display: none;
        width: 120px;
        background-color: black;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px 0;
        
        /* Position the tooltip */
        position: absolute;
        z-index: 1;
        top: -5px;
        left: 105%;
    }

    .remark:hover .tooltiptext {
        display: inline;
    }

    table {
        border-collapse: collapse;
    }

    .spaceholder {
        height: 5px;
    }

</style>
<body onload="getMTRData('LHP');getMTRData('NOP');getMTRData('TIK');">
    <div class="header" id="warning-message">
        abc
    </div>
    <div id="prioritybox"  style="border: solid; border-width: 2.5px; display: none"></div>
    <div class="spaceholder"></div>
    <div id="prioritybox2"  style="border: solid; border-width: 2.5px; display: none"></div>
    <div class="spaceholder"></div>
    <div id="prioritybox3"  style="border: solid; border-width: 2.5px; display: none"></div>
    <div class="spaceholder"></div>
    <div style="border: solid; border-width: 2.5px" id="fromLOHAS">
        <table style="min-width: 100%;">
            <tr>
                <td><span class="heading">康城站</span><span class="material-icons">&#xe56f</span></td>
                <td colspan="2" align="center"><span class="heading">炮台山站</span></td>
            </tr>
            <tr>
                <td style="width: 33%;vertical-align: top; border-bottom: solid; border-width: 1px;"><span id="nexttraintime">Test</span></td>
                <td style="width: 33%;vertical-align: top; border-bottom: solid; border-width: 1px;"><span id="FortressHilltoHKSH">Test</span></td>
                <td style="width: 33%;vertical-align: top; border-bottom: solid; border-width: 1px;"><span id="FortressHilltoTWEH">Test</span></td>
            </tr>
        </table>
        <table>
            <tr>
                <td style="width: 33%;"><span class="heading">康城往將隧</span></td>
                <td style="width: 33%;"></td>
                <td style="width: 33%;"></td>
            </tr>
            <tr>
                <td><span id="LOHAStoTKOtunnel">Test</span></td>
                <td align="center"> -> </td>
                <td><span id="TKOtunneltoHKI"></span></td>
            </tr>
        </table>
    </div>
    <div class="spaceholder"></div>
    <div id="toLOHASMTR" style="border: solid; border-width: 2.5px">
        <table style="min-width: 100%;">
            <tr>
                <td style="min-width:50%"><span class="heading">北角站</span><span class="material-icons">&#xe56f</span></td>
                <td style="min-width:50%"><span class="heading">調景嶺站</span><span class="material-icons">&#xe56f</span></td>
            </tr>
            <tr>
                <td style="vertical-align: top"><span id="fromNP">time from NP</span></td>
                <td style="vertical-align: top"><span id="fromTIK">time from TKO</span></td>   
            </tr>
        </table>
    </div>
    <div class="spaceholder"></div>
    <div class="toLOHAS fromHKSH" id="HKSH" style="width: 100%; border: solid; border-width: 2.5px">
        <table style="min-width: 100%;">
            <tr>
                <td><span class="heading">HKSH</span></td>
            </tr>
            <tr>
                <td style="min-width:50%"><span id="HKSHtoCWB">Test</span></td>
                <td style="min-width:50%; vertical-align: top"><span id="HKSHtoOthers">Test</span></td>
            </tr>
        </table>
    </div>    
    <div class="spaceholder"></div>
    <div id="toLOHASbus" style="width: 100%;border: solid; border-width: 2.5px">
        <table style="min-width: 100%;">
            <tr>
                <td style="width: 0%; display: none"><span class="heading">灣仔消防局</span></td>
                <td style="min-width:50%"><span class="heading">維多利亞公園</span></td>
                <td style="width: 0%; display: none"><span class="heading">銀幕街</span></td>
                <td style="min-width:50%;"><span class="heading">將隧往康城</span></td>
            </tr>
            <tr>
                <td align="center" style="background-color: lightgoldenrodyellow;"><span style="font-size: 1em; font-weight: bold;"> 603要喺東隧口落</span></td>
            </tr>
            <tr>
                <td style="width: 0%;display: none"><span id="WanChaiFireStationtoTKO">Test</span></td>
                <td style="min-width:50%; vertical-align: top;"><span id="VictoriaParktoTKO">Test</span></td>
                <td style="width: 0%; display: none"><span id="TinHautoTKO">Test</span></td>
                <td style="min-width:50%; vertical-align: top"><span id="TKOtunneltoLOHAS">Test</span><br><span class="heading">東隧往將隧</span><span id="EHCtoTKO">Test</span></td>
            </tr>
        </table>
    </div>


    <div class="header">
        <p><button id="button" onclick="test()">Test</button></p>
        <p>width = <span id="demo"></span></p>
        <a href="test.html">Go to page 2</a>
    </div>

    <script language="JavaScript">

        var elementidarr = ['TKOtunneltoLOHAS',
                            'LOHAStoTKOtunnel',
                            'TKOtunneltoHKI',
                            'WanChaiFireStationtoTKO',
                            'VictoriaParktoTKO',
                            'HKSHtoCWB',
                            'FortressHilltoHKSH',
                            'FortressHilltoTWEH',
                            'TinHautoTKO',
                            'EHCtoTKO',
                            'HKSHtoOthers'];
        var elementarr = [[],[],[],[],[],[],[],[],[],[],[]];

        
        getBustime('KMB','97D1981DE7ECBCE7','98',0,'','1');
        getBustime('NWFB','003595', '797', 0);
        getBustime('KMB','07142A6203E50A47','98',1,'','1');
        getBustime('NWFB','002928', '797', 1, 'O');
        getBustime('KMB', '5BEC0CCDD7EE4A8C', '690', 2, '','1');
        getBustime('CTB', '003589', '690', 2);

        
        /* WanChaiFireStationtoTKO
        getBustime('NWFB', '002437', '601P', 3);
        getBustime('CTB', '002437', '690', 3);
        getBustime('CTB', '002437', '619', 3);
        getBustime('CTB', '002437', '619X', 3);
        getBustime('NWFB', '002437', '601', 3);
        getBustime('KMB', 'CCBCD7F613287BC8', '601P', 3, '','1');
        getBustime('KMB', 'A07CC0A6D462A579', '690', 3, '','1');
        getBustime('KMB', 'A07CC0A6D462A579', '619', 3, '','1');
        getBustime('KMB', 'A07CC0A6D462A579', '619X', 3, '','1');
        getBustime('KMB', 'F1A22B170518051B', '603', 3, '','1');
        getBustime('KMB', 'CCBCD7F613287BC8', '601', 3, '','1');
        */

        getBustime('NWFB', '001213', '601P', 4);
        getBustime('NWFB', '001213', '601', 4);
        getBustime('CTB', '001213', '690', 4);
        getBustime('CTB', '001213', '619', 4);
        getBustime('CTB', '001213', '619X', 4);
        getBustime('KMB', '913E96996F3B7E3A', '601P', 4, '','1');
        getBustime('KMB', '913E96996F3B7E3A', '601', 4, '','1');
        getBustime('KMB', '9541036143D6CCF1', '690', 4, '','1');
        getBustime('KMB', '9541036143D6CCF1', '619', 4, '','1');
        getBustime('KMB', '9541036143D6CCF1', '619X', 4, '','1');
        getBustime('KMB', '84C5EBC00642536A', '603', 4, '','1');
        getBustime('CTB', '002552', '8X', 5);
        getBustime('CTB', '002552', '19', 5);
        getBustime('CTB', '001283', '8X', 6);
        getBustime('CTB', '001283', '19', 6);
        getBustime('CTB', '001283', '10', 6);
        getBustime('CTB', '001283', '678', 7);
        getBustime('KMB', 'DA2677E4FF848D7C', '678', 7,'','1');

        /*TinHautoTKO
        getBustime('NWFB', '001259', '601P', 8);
        getBustime('CTB', '001259', '690', 8);
        getBustime('CTB', '001259', '619', 8);
        getBustime('CTB', '001259', '619X', 8);
        getBustime('NWFB', '001259', '601', 8);
        getBustime('KMB', '328C9939240A94CA', '601P', 8, '','1');
        getBustime('KMB', '1A0BCDF4BDC3E1A9', '690', 8, '','1');
        getBustime('KMB', '1A0BCDF4BDC3E1A9', '619', 8, '','1');
        getBustime('KMB', '1A0BCDF4BDC3E1A9', '619X', 8, '','1');
        getBustime('KMB', '328C9939240A94CA', '601', 8, '','1');
        */

        getBustime('CTB', '001464', '690', 9);
        getBustime('NWFB', '001464', '694', 9);
        getBustime('CTB', '001464', '619X', 9)
        getBustime('KMB', '991E47DBD416B908', '690', 9, '','1');
        getBustime('KMB', 'D678B3364437D16B', '619X', 9, '','1');
        getBustime('CTB', '002552', '1', 10);
        getBustime('CTB', '002552', '117', 10);
        getBustime('KMB', '0B17DA299C307855', '117', 10, '','1');
		getBustime('NWFB', '002552', '1M', 10);


        getLocation();

		function getMTRData(sta){
            
	        var i;
	        var d;
	        var s = "";
	        var s1 = "";
            var deststring;
            var dest;
            var m, m1, d1;
	        var objvar;
	        let request = new XMLHttpRequest();
            var timestr;
            
            request.open('GET', ('https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=TKL&sta=' + sta));
            request.responseType = 'json';
            request.onload = function() {
                const rawdata = request.response;
                console.log(rawdata);
                if (rawdata['status'] == 1){
                    if (sta == 'LHP') {
                        objvar = rawdata['data']['TKL-LHP']['DOWN'];
                    } else if (sta == 'NOP') {
                        objvar = rawdata['data']['TKL-NOP']['UP'];
                    } else if (sta == 'TIK') {
                        objvar = rawdata['data']['TKL-TIK']['UP'];
                    }


                    for (i = 0; i < (objvar.length); i++){
                        timestr = objvar[i]['time']
                        timestr = timestr.substr(11,5)
                        dest = objvar[i]['dest']
                        s1 = '';
                        switch (dest) {
                            case 'NOP':
                                deststring = '北角';
                                break;
                            case 'QUB':
                                deststring = '鰂魚涌';
                                break;
                            case 'YAT':
                                deststring = '油塘';
                                break;
                            case 'TIK':
                                deststring = '調景嶺';
                                break;
                            case 'TKO':
                                deststring = '將軍澳';
                                break;
                            case 'LHP':
                                deststring = '康城';
                                s1 = ' style="color: MediumBlue; font-weight: bold"';
                                break;
                            case 'HAH':
                                deststring = '坑口';
                                break;
                            case 'POA':
                                deststring = '寶琳';
                        }
                                    
                        //if (((sta == 'TKO') && (dest == 'LHP')) || (sta != 'TKO')) {
                            s = s + '<tr><td style="vertical-align: top"><span class="time"' + s1 + '>' + timestr + '   ' + '</span></td><td><span class="dest"' + s1 + '>' + deststring + '</span></td></tr>';
                        //}

                        
                    }
                    
                    s = '<table>' + s + '</table>';
                    if (sta == 'LHP') {	    
                        document.getElementById('nexttraintime').innerHTML = s;
                    } else if (sta == 'NOP') {
                        document.getElementById('fromNP').innerHTML = s;
                    } else if (sta == 'TIK') {
                        document.getElementById('fromTIK').innerHTML = s;
                    };
                    document.getElementById('warning-message').style.display='none';
                } else {
                    document.getElementById('warning-message').innerText = rawdata['message'];
                    document.getElementById('warning-message').style.display='block';

                }
			
            };
	        request.send();

        };


        function getBustime(buscompany,stopid,routeid,elementid,direction,servicevariant){
            let reqstring;
            let request = new XMLHttpRequest();
            let timestr, timeobj;
            let returnarr = [];
            let objvar;
            let i;

            if (buscompany == 'KMB') {
                reqstring = 'https://data.etabus.gov.hk/v1/transport/kmb/eta/' + stopid + '/' + routeid + '/' + servicevariant;
            } else {
                reqstring = 'https://rt.data.gov.hk/v1/transport/citybus-nwfb/eta/' + buscompany + '/' + stopid + '/' + routeid;
            }
            
            request.open('GET', reqstring);
            request.responseType = 'json';
            request.onload = function() {    
                const rawdata = request.response;

                objvar = rawdata['data']
                for (i = 0; i < (objvar.length); i++){
                    timestr = objvar[i]['eta'];
                    if (typeof timestr != 'string') {
                        timestr = '';
                    }
                    
                    if (timestr != '') {
                        timeobj = new Date(timestr);
                        
                        
                        if (objvar[i]['rmk_tc'] != '九巴時段'){
                            if ((direction === undefined) || (direction == "")) {
                                returnarr.push({route:objvar[i]['route'], time:timeobj, dest:objvar[i]['dest_tc'], remark:objvar[i]['rmk_tc'], timestr:timestr});
                            } else {
                                if (objvar[i]['dir'] == direction) {
                                    returnarr.push({route:objvar[i]['route'], time:timeobj, dest:objvar[i]['dest_tc'], remark:objvar[i]['rmk_tc'], timestr:timestr});
                                }
                            }
                        }
                    }
                }

                updateElement(elementid,returnarr);
                
                return returnarr;
                
            };
            request.send();

        }

        



        function updateElement(elementid,returnarr){
            let outputstr = '';
            let remarkstr = '';
            let highlightstr = '';
            elementarr[elementid] = elementarr[elementid].concat(returnarr);

            
            elementarr[elementid].sort(function(a,b){return a.time - b.time});

            for (i = 0; i < elementarr[elementid].length; i++){
                highlightstr = '';
                if (elementarr[elementid][i].remark == '原定班次') {
                    remarkstr = '<span class="material-icons">&#xe8b5</span><span class="tooltiptext">' + elementarr[elementid][i].remark + '</span>';
                } else if (elementarr[elementid][i].remark == '最後班次已過') {
                    remarkstr = '';
                } else if (elementarr[elementid][i].remark != '') {
                    remarkstr = '<span class="material-icons">&#xe002</span><span class="tooltiptext">' + elementarr[elementid][i].remark + '</span>';
                } else {
                    remarkstr = '';
                }

                if ((elementarr[elementid][i].route == '690') || (((elementarr[elementid][i].route == '8X') || (elementarr[elementid][i].route == '19')) && (elementid == 6))) {
                    highlightstr = ' style="color: MediumBlue; font-weight: bold"';
                }
                outputstr = outputstr + '<tr><td style="vertical-align: top"><span class="route"' + highlightstr + '>' + elementarr[elementid][i].route + '&nbsp;&nbsp;</span></td><td style="vertical-align: top"><span class="time"' + highlightstr + '>' + elementarr[elementid][i].timestr.substr(11,5) + ' ' + '</span></td><td><span class="remark">' + remarkstr + '</span></td></tr>';
            }
            outputstr = '<table>' + outputstr + '</table>';
            document.getElementById(elementidarr[elementid]).innerHTML = outputstr;
        }

        
        var x = document.getElementById("demo");

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else { 
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            let lat = position.coords.latitude;
            let longi = position.coords.longitude;
            
            if ((lat >= 22.290334) && (lat <= 22.298736) && (longi >= 114.266676) && (longi <= 114.275609)) {
                // in LOHAS
                

            } else if ((lat >= 22.267764899999236) && (lat <= 22.271100907486268) && (longi >= 114.18121319767681) && (longi <= 114.18583732584327)) {
                // in HKSH
                document.getElementById("prioritybox").innerHTML = document.getElementById("HKSH").innerHTML;
                document.getElementById("prioritybox2").innerHTML = document.getElementById("toLOHASbus").innerHTML;
                document.getElementById("prioritybox3").innerHTML = document.getElementById("toLOHASMTR").innerHTML;
                document.getElementById("HKSH").style.display = 'none';
                document.getElementById("toLOHASbus").style.display = 'none';
                document.getElementById("toLOHASMTR").style.display = 'none';
                document.getElementById("prioritybox").style.display = 'block';
                document.getElementById("prioritybox2").style.display = 'block';
                document.getElementById("prioritybox3").style.display = 'block';
            } else if ((lat >= 22.275742041795617) && (lat <= 22.283183716396373) && (longi >= 114.17240484677927) && (longi <= 114.18926810351255)) {
                // in Wan Chai / CWB
                document.getElementById("prioritybox").innerHTML = document.getElementById("toLOHASbus").innerHTML;
                document.getElementById("prioritybox2").innerHTML = document.getElementById("toLOHASMTR").innerHTML;
                document.getElementById("toLOHASbus").style.display = 'none';
                document.getElementById("toLOHASMTR").style.display = 'none';
                document.getElementById("prioritybox").style.display = 'block';
                document.getElementById("prioritybox2").style.display = 'block';
            } 
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                x.innerHTML = "User denied the request for Geolocation."
                break;
                case error.POSITION_UNAVAILABLE:
                x.innerHTML = "Location information is unavailable."
                break;
                case error.TIMEOUT:
                x.innerHTML = "The request to get user location timed out."
                break;
                case error.UNKNOWN_ERROR:
                x.innerHTML = "An unknown error occurred."
                break;
            }
        }

        function test() {
            // in HKSH
            document.getElementById("prioritybox").innerHTML = document.getElementById("HKSH").innerHTML;
            document.getElementById("HKSH").style.display = 'none';
            document.getElementById("prioritybox").style.display = 'block';
        }

        
    </script>
	
</body>
</head>
</html>